<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperAdmin Dashboard - Expense Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom scrollbar for desktop sidebar */
        .sidebar-scroll {
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #cbd5e0 #f7fafc; /* thumb and track color for Firefox */
        }
        .sidebar-scroll::-webkit-scrollbar {
            width: 8px; /* width of the scrollbar */
        }
        .sidebar-scroll::-webkit-scrollbar-track {
            background: #f7fafc; /* color of the track */
        }
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e0; /* color of the scroll thumb */
            border-radius: 20px; /* roundness of the scroll thumb */
            border: 2px solid #f7fafc; /* creates padding around scroll thumb */
        }

        /* Hide scrollbar for mobile bottom nav on small screens */
        @media (max-width: 767px) {
            .hide-on-mobile {
                display: none;
            }
            .show-on-mobile {
                display: flex; /* Or block, depending on context */
            }
             body {
                padding-bottom: 64px; /* Space for the fixed bottom navbar */
            }
        }
        @media (min-width: 768px) {
            .hide-on-desktop {
                display: none;
            }
            .show-on-mobile {
                display: none; /* Hide mobile nav on desktop */
            }
        }

        /* Toast styles */
        #toast {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: translateY(100%);
            opacity: 0;
            bottom: 1rem;
            right: 1rem;
            z-index: 1000;
        }
        #toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Active tab styling */
        .tab-btn.active {
            background-color: #2563eb; /* bg-blue-600 */
            color: white;
            font-weight: 600;
        }

        .bottom-nav-item.active .nav-icon {
            color: #2563eb; /* blue-600 */
        }
        .bottom-nav-item.active .nav-label {
            color: #2563eb; /* blue-600 */
            font-weight: 600;
        }

        /* Text colors for status/funds */
        .text-status-active { color: #22c55e; /* green-500 */ }
        .text-status-inactive { color: #ef4444; /* red-500 */ }
        .text-status-pending { color: #f59e0b; /* amber-500 */ }
        .text-status-approved { color: #22c55e; /* green-500 */ }
        .text-status-rejected { color: #ef4444; /* red-500 */ }
        .text-remaining-low { color: #f59e0b; /* amber-500 */ } /* For remaining funds */
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col md:flex-row font-sans antialiased">

    <div id="toast" class="fixed p-4 rounded-lg shadow-lg flex items-center space-x-3 transition-all duration-300 bg-white border">
        <div id="toastIcon"></div>
        <div id="toastMessage" class="text-sm font-medium text-gray-800"></div>
    </div>

    <aside class="w-64 bg-white shadow-lg flex-shrink-0 hide-on-mobile md:flex flex-col">
        <div class="p-6 border-b border-gray-200">
            <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-chart-pie mr-3 text-indigo-600"></i>
                ExpensePilot
            </h1>
        </div>
        <div class="p-6 flex items-center border-b border-gray-200">
            <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold text-lg mr-3">
                SA
            </div>
            <div>
                <p id="userNameSidebar" class="font-semibold text-gray-800">SuperAdmin Name</p>
                <span class="text-sm text-gray-500">SuperAdmin</span>
            </div>
        </div>
        <nav class="flex-grow p-4 sidebar-scroll overflow-y-auto">
            <ul class="space-y-2">
                <li>
                    <a href="#" class="tab-btn flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors active" data-tab="dashboard">
                        <i class="fas fa-th-large mr-3 text-lg"></i>
                        Dashboard
                    </a>
                </li>
                <li>
                    <a href="#" class="tab-btn flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors" data-tab="transactions">
                        <i class="fas fa-exchange-alt mr-3 text-lg"></i>
                        Transactions
                    </a>
                </li>
                <li>
                    <a href="#" class="tab-btn flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors" data-tab="management">
                        <i class="fas fa-users-cog mr-3 text-lg"></i>
                        Management
                    </a>
                </li>
                <li>
                    <a href="#" class="tab-btn flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors" data-tab="reports">
                        <i class="fas fa-chart-line mr-3 text-lg"></i>
                        Reports
                    </a>
                </li>
                <li>
                    <a href="#" class="tab-btn flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors" data-tab="settings">
                        <i class="fas fa-cog mr-3 text-lg"></i>
                        Settings
                    </a>
                </li>
            </ul>
        </nav>
        <div class="p-4 border-t border-gray-200">
            <button id="logoutBtnSidebar" class="w-full flex items-center justify-center p-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                <i class="fas fa-sign-out-alt mr-2"></i>
                Logout
            </button>
        </div>
    </aside>

    <main class="flex-grow p-4 md:p-8 overflow-auto">
        <header class="bg-white rounded-lg shadow-md p-4 mb-6 flex items-center justify-between md:hidden">
            <h1 class="text-xl font-bold text-gray-800">SuperAdmin Dashboard</h1>
            <div class="flex items-center space-x-3">
                <div class="w-9 h-9 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold text-md">
                    SA
                </div>
                <span id="userNameMobile" class="font-semibold text-gray-800 text-sm"></span>
            </div>
        </header>

        <section id="dashboard" class="tab-content">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-md p-6 flex items-center justify-between">
                    <div>
                        <p class="text-lg text-gray-500">Total Allocated</p>
                        <p id="totalAllocated" class="text-3xl font-bold text-blue-600 mt-1">₹0.00</p>
                    </div>
                    <i class="fas fa-money-bill-alt text-4xl text-blue-200"></i>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 flex items-center justify-between">
                    <div>
                        <p class="text-lg text-gray-500">Total Spent</p>
                        <p id="totalSpent" class="text-3xl font-bold text-gray-800 mt-1">₹0.00</p>
                    </div>
                    <i class="fas fa-wallet text-4xl text-gray-300"></i>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 flex items-center justify-between">
                    <div>
                        <p class="text-lg text-gray-500">Remaining Funds</p>
                        <p id="remainingFunds" class="text-3xl font-bold text-remaining-low mt-1">₹0.00</p>
                    </div>
                    <i class="fas fa-coins text-4xl text-yellow-200"></i>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 flex items-center justify-between">
                    <div>
                        <p class="text-lg text-gray-500">Active Users</p>
                        <p id="activeUsers" class="text-3xl font-bold text-green-600 mt-1">0</p>
                    </div>
                    <i class="fas fa-user-check text-4xl text-green-200"></i>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Fund Allocation by Supervisors</h3>
                    <div class="relative h-72">
                        <canvas id="supervisorAllocationChart"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Overall Fund Distribution</h3>
                    <div class="relative h-72">
                        <canvas id="fundDistributionChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Supervisor Summary</h3>
                        <a href="#" class="text-blue-600 hover:underline text-sm" onclick="switchTab('management'); return false;">View All</a>
                    </div>
                    <div id="supervisorSummaryList" class="space-y-4">
                        <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                            <i class="fas fa-user-tie text-xl text-indigo-500 mr-4"></i>
                            <div>
                                <p class="font-medium text-gray-800">Loading Supervisors...</p>
                                <p class="text-sm text-gray-500">N/A</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Labour Summary</h3>
                        <a href="#" class="text-blue-600 hover:underline text-sm" onclick="switchTab('management'); return false;">View All</a>
                    </div>
                    <div id="labourSummaryList" class="space-y-4">
                        <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                            <i class="fas fa-hard-hat text-xl text-amber-500 mr-4"></i>
                            <div>
                                <p class="font-medium text-gray-800">Loading Labours...</p>
                                <p class="text-sm text-gray-500">N/A</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="transactions" class="tab-content hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Transaction History</h2>

            <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
                    <div class="flex flex-wrap items-center gap-4">
                        <select id="transactionTypeFilter" class="form-select border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Types</option>
                            <option value="allocation">Allocation</option>
                            <option value="expense">Expense</option>
                        </select>
                        <input type="text" id="fromUserFilter" placeholder="From User" class="form-input border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
                        <input type="text" id="toUserFilter" placeholder="To User" class="form-input border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
                        <input type="date" id="startDateFilter" class="form-input border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
                        <input type="date" id="endDateFilter" class="form-input border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
                        <button onclick="applyTransactionFilters()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                            <i class="fas fa-filter mr-2"></i> Apply Filters
                        </button>
                         <button onclick="clearTransactionFilters()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors flex items-center">
                            <i class="fas fa-times mr-2"></i> Clear
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-3 mt-4 md:mt-0">
                        <button onclick="openAllocateFundsModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                            <i class="fas fa-plus-circle mr-2"></i> Allocate Funds
                        </button>
                        <button onclick="openAddUserModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                            <i class="fas fa-user-plus mr-2"></i> Add User
                        </button>
                        <button onclick="fetchAiInsights()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center">
                            <i class="fas fa-brain mr-2"></i> AI Insights
                        </button>
                        <button onclick="exportTransactions()" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors flex items-center">
                            <i class="fas fa-file-export mr-2"></i> Export Report
                        </button>
                    </div>
                </div>
                 <div id="aiInsightsContainer" class="bg-blue-50 border-l-4 border-blue-400 text-blue-700 p-4 rounded-lg mb-6 hidden" role="alert">
                    <p class="font-bold mb-2">AI Insights</p>
                    <div id="aiInsightsContent"></div>
                </div>

                <div class="overflow-x-auto bg-white rounded-xl shadow-md">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">From → To</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Loading transactions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        

        <section id="management" class="tab-content hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">User Management</h2>

            <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Supervisor Management</h3>
                    <div class="flex flex-wrap gap-2 mt-3 md:mt-0">
                         <input type="text" id="searchAdmins" onkeyup="filterAdmins()" placeholder="Search Supervisors..." class="form-input border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                        <button onclick="openAddUserModal('admin')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center text-sm">
                            <i class="fas fa-user-plus mr-2"></i> Add Supervisor
                        </button>
                        <button onclick="exportSupervisors()" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors flex items-center text-sm">
                            <i class="fas fa-file-export mr-2"></i> Export
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fund Allocated</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fund Used</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remaining</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="supervisorsTableBody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Loading supervisors...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Labour Management</h3>
                     <div class="flex flex-wrap gap-2 mt-3 md:mt-0">
                         <input type="text" id="searchEmployees" onkeyup="filterEmployees()" placeholder="Search Labours..." class="form-input border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                        <button onclick="openAddUserModal('employee')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center text-sm">
                            <i class="fas fa-user-plus mr-2"></i> Add Labour
                        </button>
                        <button onclick="exportEmployees()" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors flex items-center text-sm">
                            <i class="fas fa-file-export mr-2"></i> Export
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned Admin</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Funds Allocated</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Funds Used</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remaining</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="employeesTableBody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Loading employees...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="reports" class="tab-content hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Reports</h2>
            <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Expense Trends Report</h3>
                <div class="relative h-96 mb-6">
                    <canvas id="expenseTrendsChart"></canvas>
                </div>
                <div class="flex justify-end">
                    <button onclick="downloadReport()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                        <i class="fas fa-download mr-2"></i> Download Full Report
                    </button>
                </div>
            </div>
        </section>

         <section id="settings" class="tab-content hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Settings</h2>
            <div class="bg-white rounded-xl shadow-md p-6">
                <p class="text-gray-700">Settings content will go here. This section is under development.</p>
                <p class="text-gray-500 text-sm mt-2">Example: User profile settings, notification preferences, etc.</p>
            </div>
        </section>
    </main>

    <nav class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 shadow-lg py-2 show-on-mobile flex justify-around items-center z-50">
        <a href="#" class="bottom-nav-item flex flex-col items-center p-2 text-gray-600 active" data-tab="dashboard">
            <i class="fas fa-th-large text-xl nav-icon"></i>
            <span class="text-xs mt-1 nav-label">Dashboard</span>
        </a>
        <a href="#" class="bottom-nav-item flex flex-col items-center p-2 text-gray-600" data-tab="transactions">
            <i class="fas fa-exchange-alt text-xl nav-icon"></i>
            <span class="text-xs mt-1 nav-label">Transactions</span>
        </a>
        <a href="#" class="bottom-nav-item flex flex-col items-center p-2 text-gray-600" data-tab="management">
            <i class="fas fa-users-cog text-xl nav-icon"></i>
            <span class="text-xs mt-1 nav-label">Management</span>
        </a>
        <a href="#" class="bottom-nav-item flex flex-col items-center p-2 text-gray-600" data-tab="reports">
            <i class="fas fa-chart-line text-xl nav-icon"></i>
            <span class="text-xs mt-1 nav-label">Reports</span>
        </a>
        <button id="mobileLogoutBtn" class="bottom-nav-item flex flex-col items-center p-2 text-red-600">
            <i class="fas fa-sign-out-alt text-xl nav-icon"></i>
            <span class="text-xs mt-1 nav-label">Logout</span>
        </button>
    </nav>

    <div id="allocateFundsModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Allocate Funds</h3>
                <button onclick="closeAllocateFundsModal()" class="text-gray-500 hover:text-gray-800">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="allocateFundsForm" class="space-y-4">
                <div>
                    <label for="allocateSupervisor" class="block text-sm font-medium text-gray-700 mb-1">Select Supervisor</label>
                    <select id="allocateSupervisor" name="admin_id" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Loading supervisors...</option>
                    </select>
                </div>
                <div>
                    <label for="allocateAmount" class="block text-sm font-medium text-gray-700 mb-1">Amount (₹)</label>
                    <input type="number" id="allocateAmount" name="amount" required min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="allocateRemark" class="block text-sm font-medium text-gray-700 mb-1">Remark (Optional)</label>
                    <textarea id="allocateRemark" name="remark" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeAllocateFundsModal()" class="px-5 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">Cancel</button>
                    <button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Allocate</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addUserModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 id="addUserModalTitle" class="text-2xl font-bold text-gray-800">Add New User</h3>
                <button onclick="closeAddUserModal()" class="text-gray-500 hover:text-gray-800">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="addUserForm" class="space-y-4">
                <input type="hidden" id="editUserId">
                <div>
                    <label for="userRole" class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                    <select id="userRole" name="role" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="admin">Supervisor</option>
                        <option value="employee">Labour</option>
                    </select>
                </div>
                <div>
                    <label for="userName" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" id="addUserName" name="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="userEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="userEmail" name="email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="userPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="userPassword" name="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <p id="passwordHint" class="text-xs text-gray-500 mt-1 hidden">Leave blank to keep current password.</p>
                </div>
                <div>
                    <label for="userPhone" class="block text-sm font-medium text-gray-700 mb-1">Phone (Optional)</label>
                    <input type="tel" id="userPhone" name="phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div id="fundAllocationField" class="hidden">
                    <label for="userFundAllocation" class="block text-sm font-medium text-gray-700 mb-1">Initial Fund Allocation (₹)</label>
                    <input type="number" id="userFundAllocation" name="initial_fund" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                 <div class="flex items-center" id="userStatusField">
                    <input type="checkbox" id="userIsActive" name="is_active" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="userIsActive" class="ml-2 block text-sm text-gray-900">Account Active</label>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeAddUserModal()" class="px-5 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">Cancel</button>
                    <button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let supervisorAllocationChart;
        let fundDistributionChart;
        let expenseTrendsChart;

        // Utility function to format currency
        function formatCurrency(amount) {
            if (typeof amount === 'string') {
                amount = parseFloat(amount);
            }
            if (isNaN(amount)) {
                return '₹0.00';
            }
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        // Toast Notification Logic
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');

            toastMessage.textContent = message;
            toast.className = 'fixed p-4 rounded-lg shadow-lg flex items-center space-x-3 transition-all duration-300';

            // Reset classes and apply new ones
            toast.classList.remove('bg-green-50', 'border-green-200', 'bg-red-50', 'border-red-200', 'bg-yellow-50', 'border-yellow-200', 'bg-blue-50', 'border-blue-200');
            toastIcon.innerHTML = '';

            if (type === 'success') {
                toastIcon.innerHTML = '<i class="fas fa-check-circle text-green-500 text-xl"></i>';
                toast.classList.add('bg-green-50', 'border-green-200');
            } else if (type === 'error') {
                toastIcon.innerHTML = '<i class="fas fa-exclamation-circle text-red-500 text-xl"></i>';
                toast.classList.add('bg-red-50', 'border-red-200');
            } else if (type === 'warning') {
                toastIcon.innerHTML = '<i class="fas fa-exclamation-triangle text-yellow-500 text-xl"></i>';
                toast.classList.add('bg-yellow-50', 'border-yellow-200');
            } else { // info
                toastIcon.innerHTML = '<i class="fas fa-info-circle text-blue-500 text-xl"></i>';
                toast.classList.add('bg-blue-50', 'border-blue-200');
            }

            // Show the toast
            toast.classList.add('show');

            // Auto hide after 5 seconds
            setTimeout(hideToast, 5000);
        }

        function hideToast() {
            document.getElementById('toast').classList.remove('show');
        }


        // Logout Functionality
        async function logout() {
            try {
                const response = await fetch('/auth/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });
                const data = await response.json();
                if (response.ok) {
                    showToast(data.message, 'success');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1000); // Redirect after toast message
                } else {
                    showToast(`Logout Error: ${data.error || 'Failed to logout.'}`, 'error');
                }
            } catch (error) {
                console.error('Error during logout:', error);
                showToast('An error occurred during logout. Please try again.', 'error');
            }
        }

        // Fetch User Name for Header
        async function fetchUserName() {
            try {
                const response = await fetch('/auth/me');
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        window.location.href = '/login'; // Redirect to login if not authenticated
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.authenticated && data.user) {
                    const userName = data.user.name;
                    document.getElementById('userNameSidebar').textContent = userName;
                    document.getElementById('userNameMobile').textContent = userName;
                    // Initial for charts if needed
                    renderDashboardCharts(); // Re-render charts after user data
                }
            } catch (error) {
                console.error('Error fetching user info:', error);
                document.getElementById('userNameSidebar').textContent = 'Guest';
                document.getElementById('userNameMobile').textContent = 'Guest';
                showToast('Failed to load user information.', 'error');
            }
        }

        // Tab Switching Logic
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            document.getElementById(tabId).classList.remove('hidden');

            // Update active state for desktop sidebar
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');

            // Update active state for mobile bottom nav
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.bottom-nav-item[data-tab="${tabId}"]`)?.classList.add('active');

            // Load data specific to the tab
            if (tabId === 'dashboard') {
                loadDashboardData();
            } else if (tabId === 'transactions') {
                loadTransactions();
            } else if (tabId === 'management') {
                loadSupervisors();
                loadEmployees();
            } else if (tabId === 'reports') {
                loadReportsData();
            } else if (tabId === 'settings') {
                // Settings tab might not need data loading initially
            }
             // Ensure AI insights are re-fetched if on transactions tab
            const aiInsightsContainer = document.getElementById('aiInsightsContainer');
            if (tabId === 'transactions') {
                aiInsightsContainer.classList.add('hidden'); // Hide by default until fetched
            }
        }

        // Render Dashboard Charts
        async function renderDashboardCharts() {
            const overviewData = await fetchDashboardOverview();
            if (!overviewData) return;

            // Bar Chart: Fund Allocation by Supervisor
            const adminLabels = overviewData.admins_overview.map(admin => admin.name);
            const allocatedData = overviewData.admins_overview.map(admin => admin.allocated);
            const spentData = overviewData.admins_overview.map(admin => admin.spent);
            const remainingData = overviewData.admins_overview.map(admin => admin.remaining);

            const supervisorCtx = document.getElementById('supervisorAllocationChart').getContext('2d');
            if (supervisorAllocationChart) {
                supervisorAllocationChart.destroy();
            }
            supervisorAllocationChart = new Chart(supervisorCtx, {
                type: 'bar',
                data: {
                    labels: adminLabels,
                    datasets: [
                        {
                            label: 'Allocated',
                            data: allocatedData,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)', // blue-500
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Spent',
                            data: spentData,
                            backgroundColor: 'rgba(107, 114, 128, 0.8)', // gray-500
                            borderColor: 'rgba(107, 114, 128, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Remaining',
                            data: remainingData,
                            backgroundColor: 'rgba(245, 158, 11, 0.8)', // amber-500
                            borderColor: 'rgba(245, 158, 11, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (₹)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        },
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });

            // Pie Chart: Fund Distribution
            const totalAllocated = parseFloat(overviewData.total_allocated);
            const totalSpent = parseFloat(overviewData.total_spent);
            const remainingFunds = parseFloat(overviewData.remaining_funds);

            const fundDistributionCtx = document.getElementById('fundDistributionChart').getContext('2d');
            if (fundDistributionChart) {
                fundDistributionChart.destroy();
            }
            fundDistributionChart = new Chart(fundDistributionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Total Allocated', 'Total Spent', 'Remaining Funds'],
                    datasets: [{
                        data: [totalAllocated, totalSpent, remainingFunds],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)', // blue-500
                            'rgba(107, 114, 128, 0.8)', // gray-500
                            'rgba(245, 158, 11, 0.8)'  // amber-500
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw;
                                    return label + ': ' + formatCurrency(value);
                                }
                            }
                        },
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        // Fetch Dashboard Overview Data
        async function fetchDashboardOverview() {
            try {
                const response = await fetch('/superadmin/overview');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                document.getElementById('totalAllocated').textContent = formatCurrency(data.total_allocated);
                document.getElementById('totalSpent').textContent = formatCurrency(data.total_spent);
                document.getElementById('remainingFunds').textContent = formatCurrency(data.remaining_funds);
                document.getElementById('activeUsers').textContent = data.active_admins; // Assuming active_admins represents active users overall

                // Update Remaining Funds color
                const remainingFundsElement = document.getElementById('remainingFunds');
                if (parseFloat(data.remaining_funds) < 10000) { // Example threshold
                    remainingFundsElement.classList.add('text-remaining-low');
                    remainingFundsElement.classList.remove('text-green-600'); // Remove any default color if exists
                } else {
                     remainingFundsElement.classList.remove('text-remaining-low');
                     remainingFundsElement.classList.add('text-green-600');
                }


                // Populate Supervisor Summary List
                const supervisorSummaryList = document.getElementById('supervisorSummaryList');
                supervisorSummaryList.innerHTML = ''; // Clear previous content
                if (data.admins_overview && data.admins_overview.length > 0) {
                    data.admins_overview.slice(0, 3).forEach(admin => { // Show top 3
                        const statusClass = admin.is_active ? 'text-status-active' : 'text-status-inactive';
                        supervisorSummaryList.innerHTML += `
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                <i class="fas fa-user-tie text-xl text-indigo-500 mr-4"></i>
                                <div>
                                    <p class="font-medium text-gray-800">${admin.name}</p>
                                    <p class="text-sm text-gray-500">${admin.email}</p>
                                    <p class="text-xs text-gray-600">Funds: ${formatCurrency(admin.allocated)} / Spent: ${formatCurrency(admin.spent)}</p>
                                </div>
                                <span class="ml-auto text-sm font-semibold ${statusClass}">${admin.is_active ? 'Active' : 'Inactive'}</span>
                            </div>
                        `;
                    });
                } else {
                    supervisorSummaryList.innerHTML = `<p class="text-gray-500 text-center py-4">No supervisors found.</p>`;
                }

                // Populate Labour Summary List (Employees)
                const labourSummaryList = document.getElementById('labourSummaryList');
                labourSummaryList.innerHTML = ''; // Clear previous content
                if (data.employees_overview && data.employees_overview.length > 0) {
                    data.employees_overview.slice(0, 3).forEach(employee => { // Show top 3
                         const statusClass = employee.is_active ? 'text-status-active' : 'text-status-inactive';
                        labourSummaryList.innerHTML += `
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                <i class="fas fa-hard-hat text-xl text-amber-500 mr-4"></i>
                                <div>
                                    <p class="font-medium text-gray-800">${employee.name}</p>
                                    <p class="text-sm text-gray-500">${employee.email}</p>
                                    <p class="text-xs text-gray-600">Assigned Admin: ${employee.admin_name || 'N/A'}</p>
                                </div>
                                <span class="ml-auto text-sm font-semibold ${statusClass}">${employee.is_active ? 'Active' : 'Inactive'}</span>
                            </div>
                        `;
                    });
                } else {
                    labourSummaryList.innerHTML = `<p class="text-gray-500 text-center py-4">No labours found.</p>`;
                }

                return data;

            } catch (error) {
                console.error('Error fetching dashboard overview:', error);
                showToast('Failed to load dashboard data. Please try again.', 'error');
                return null;
            }
        }

        // Load Dashboard Data (includes stats and charts)
        async function loadDashboardData() {
            await fetchDashboardOverview();
            await renderDashboardCharts();
        }

        // Fetch All Transactions
        async function loadTransactions() {
            const transactionsTableBody = document.getElementById('transactionsTableBody');
            transactionsTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Loading transactions...</td></tr>`;

            const type = document.getElementById('transactionTypeFilter').value;
            const fromUser = document.getElementById('fromUserFilter').value;
            const toUser = document.getElementById('toUserFilter').value;
            const startDate = document.getElementById('startDateFilter').value;
            const endDate = document.getElementById('endDateFilter').value;

            const queryParams = new URLSearchParams();
            if (type) queryParams.append('type', type);
            if (fromUser) queryParams.append('from_user', fromUser);
            if (toUser) queryParams.append('to_user', toUser);
            if (startDate) queryParams.append('start_date', startDate);
            if (endDate) queryParams.append('end_date', endDate);

            try {
                const response = await fetch(`/superadmin/transactions?${queryParams.toString()}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                transactionsTableBody.innerHTML = ''; // Clear loading message

                if (data.transactions && data.transactions.length > 0) {
                    data.transactions.forEach(transaction => {
                        const date = new Date(transaction.created_at).toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                        transactionsTableBody.innerHTML += `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${transaction.sender_name || 'System'} → ${transaction.receiver_name || 'N/A'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(transaction.amount)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${transaction.description || 'N/A'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
                            </tr>
                        `;
                    });
                } else {
                    transactionsTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No transactions found.</td></tr>`;
                }
            } catch (error) {
                console.error('Error fetching transactions:', error);
                transactionsTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-sm text-red-500 text-center">Failed to load transactions.</td></tr>`;
                showToast('Failed to load transaction history.', 'error');
            }
        }

        function applyTransactionFilters() {
            loadTransactions();
        }

        function clearTransactionFilters() {
            document.getElementById('transactionTypeFilter').value = '';
            document.getElementById('fromUserFilter').value = '';
            document.getElementById('toUserFilter').value = '';
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            loadTransactions();
        }

        async function exportTransactions() {
            showToast('Generating report...', 'info');
            // This would ideally trigger a backend endpoint that generates and returns a file
            // For now, it's a placeholder. Your backend needs to implement /superadmin/transactions-export (or similar)
            try {
                // Example: If backend generates a CSV
                const response = await fetch('/superadmin/transactions-export'); // You need to implement this endpoint
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'transactions_report.csv'; // Or .pdf, .xlsx
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                showToast('Transactions report exported successfully!', 'success');
            } catch (error) {
                console.error('Error exporting transactions:', error);
                showToast('Failed to export transactions. Backend export endpoint not implemented or failed.', 'error');
            }
        }

        async function fetchAdminsForAllocation() {
            const selectElement = document.getElementById('allocateSupervisor');
            selectElement.innerHTML = '<option value="">Loading supervisors...</option>'; // Clear and show loading

            try {
                const response = await fetch('/superadmin/admins');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                selectElement.innerHTML = '<option value="">Select Supervisor</option>'; // Default option
                if (data.admins && data.admins.length > 0) {
                    data.admins.forEach(admin => {
                        const option = document.createElement('option');
                        option.value = admin.id;
                        option.textContent = `${admin.name} (${admin.email})`;
                        selectElement.appendChild(option);
                    });
                } else {
                    selectElement.innerHTML = '<option value="">No supervisors available</option>';
                }
            } catch (error) {
                console.error('Error fetching admins for allocation:', error);
                selectElement.innerHTML = '<option value="">Failed to load supervisors</option>';
                showToast('Failed to load supervisors for fund allocation.', 'error');
            }
        }

        function openAllocateFundsModal() {
            fetchAdminsForAllocation();
            document.getElementById('allocateFundsModal').classList.remove('hidden');
        }

        function closeAllocateFundsModal() {
            document.getElementById('allocateFundsModal').classList.add('hidden');
            document.getElementById('allocateFundsForm').reset();
        }

        document.getElementById('allocateFundsForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/superadmin/allocate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (response.ok) {
                    showToast(result.message, 'success');
                    closeAllocateFundsModal();
                    loadTransactions(); // Refresh transactions and dashboard data
                    loadDashboardData();
                } else {
                    showToast(result.error || 'Failed to allocate funds.', 'error');
                }
            } catch (error) {
                console.error('Error allocating funds:', error);
                showToast('An error occurred during fund allocation.', 'error');
            }
        });


        // Fetch AI Insights for SuperAdmin
        async function fetchAiInsights() {
            const aiInsightsContainer = document.getElementById('aiInsightsContainer');
            const aiInsightsContent = document.getElementById('aiInsightsContent');
            aiInsightsContainer.classList.remove('hidden');
            aiInsightsContent.innerHTML = '<p class="text-gray-700">Loading AI insights...</p>';

            try {
                const response = await fetch('/ai/superadmin/system-analytics');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                aiInsightsContent.innerHTML = ''; // Clear loading message

                if (data.insights && data.insights.length > 0) {
                    data.insights.forEach(insight => {
                        let iconClass = '';
                        let textClass = '';
                        if (insight.type === 'success') {
                            iconClass = 'text-green-500';
                            textClass = 'text-green-800';
                        } else if (insight.type === 'warning') {
                            iconClass = 'text-yellow-500';
                            textClass = 'text-yellow-800';
                        } else if (insight.type === 'info') {
                            iconClass = 'text-blue-500';
                            textClass = 'text-blue-800';
                        }

                        aiInsightsContent.innerHTML += `
                            <div class="flex items-start mb-3">
                                <i class="fas fa-lightbulb ${iconClass} text-xl mr-3"></i>
                                <div>
                                    <h4 class="font-semibold ${textClass}">${insight.title}</h4>
                                    <p class="text-sm text-gray-700">${insight.message}</p>
                                    <p class="text-xs text-gray-600 opacity-75 mt-1">Tip: ${insight.recommendation}</p>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    aiInsightsContent.innerHTML = '<p class="text-gray-700">No new insights available at this moment.</p>';
                }
            } catch (error) {
                console.error('Error fetching AI insights:', error);
                aiInsightsContent.innerHTML = '<p class="text-red-500">Failed to load AI insights. Please try again.</p>';
                showToast('Failed to load AI insights.', 'error');
            }
        }


        // Load Supervisor Management Data
        let allAdmins = []; // Store all admins for filtering
        async function loadSupervisors() {
            const supervisorsTableBody = document.getElementById('supervisorsTableBody');
            supervisorsTableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Loading supervisors...</td></tr>`;

            try {
                const response = await fetch('/superadmin/overview'); // Re-using overview to get full admin data
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                allAdmins = data.admins_overview || []; // Store data for filtering
                renderSupervisorsTable(allAdmins);

            } catch (error) {
                console.error('Error fetching supervisors:', error);
                supervisorsTableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-red-500 text-center">Failed to load supervisors.</td></tr>`;
                showToast('Failed to load supervisors management data.', 'error');
            }
        }

        function renderSupervisorsTable(admins) {
             const supervisorsTableBody = document.getElementById('supervisorsTableBody');
             supervisorsTableBody.innerHTML = '';
             if (admins.length > 0) {
                 admins.forEach(admin => {
                    const statusText = admin.is_active ? 'Active' : 'Inactive';
                    const statusClass = admin.is_active ? 'text-status-active' : 'text-status-inactive';
                    supervisorsTableBody.innerHTML += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${admin.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${admin.email}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(admin.allocated)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(admin.spent)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><span class="${admin.remaining < 10000 ? 'text-remaining-low' : ''}">${formatCurrency(admin.remaining)}</span></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass}">${statusText}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="editUser('${admin.id}', 'admin')" class="text-blue-600 hover:text-blue-900 mr-3">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="toggleUserStatus('${admin.id}', 'admin', ${admin.is_active})" class="${admin.is_active ? 'text-red-600 hover:text-red-900' : 'text-green-600 hover:text-green-900'}">
                                    <i class="fas ${admin.is_active ? 'fa-toggle-off' : 'fa-toggle-on'}"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
             } else {
                 supervisorsTableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No supervisors found.</td></tr>`;
             }
        }

        function filterAdmins() {
            const searchValue = document.getElementById('searchAdmins').value.toLowerCase();
            const filteredAdmins = allAdmins.filter(admin =>
                admin.name.toLowerCase().includes(searchValue) ||
                admin.email.toLowerCase().includes(searchValue)
            );
            renderSupervisorsTable(filteredAdmins);
        }

        function exportSupervisors() {
             showToast('Exporting supervisors...', 'info');
             // Implement export logic (e.g., generate CSV from allAdmins data)
             const headers = ["Name", "Email", "Fund Allocated", "Fund Used", "Remaining", "Status"];
             const rows = allAdmins.map(admin => [
                 admin.name,
                 admin.email,
                 formatCurrency(admin.allocated).replace('₹', ''), // Remove currency symbol for CSV
                 formatCurrency(admin.spent).replace('₹', ''),
                 formatCurrency(admin.remaining).replace('₹', ''),
                 admin.is_active ? 'Active' : 'Inactive'
             ]);

             let csvContent = "data:text/csv;charset=utf-8,"
                 + headers.join(",") + "\n"
                 + rows.map(e => e.join(",")).join("\n");

             const encodedUri = encodeURI(csvContent);
             const link = document.createElement("a");
             link.setAttribute("href", encodedUri);
             link.setAttribute("download", "supervisors_report.csv");
             document.body.appendChild(link);
             link.click();
             link.remove();
             showToast('Supervisors report exported successfully!', 'success');
        }

        // Load Employee Management Data
        let allEmployees = []; // Store all employees for filtering
        async function loadEmployees() {
            const employeesTableBody = document.getElementById('employeesTableBody');
            employeesTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">Loading employees...</td></tr>`;

            try {
                const response = await fetch('/superadmin/employees');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                allEmployees = data.employees || []; // Store data for filtering
                renderEmployeesTable(allEmployees);

            } catch (error) {
                console.error('Error fetching employees:', error);
                employeesTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-red-500 text-center">Failed to load employees.</td></tr>`;
                showToast('Failed to load employees management data.', 'error');
            }
        }

        function renderEmployeesTable(employees) {
            const employeesTableBody = document.getElementById('employeesTableBody');
            employeesTableBody.innerHTML = '';
            if (employees.length > 0) {
                employees.forEach(employee => {
                    const statusText = employee.is_active ? 'Active' : 'Inactive';
                    const statusClass = employee.is_active ? 'text-status-active' : 'text-status-inactive';
                    employeesTableBody.innerHTML += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${employee.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.email}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.admin_name || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(employee.allocated_fund)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(employee.spent_fund)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><span class="${employee.remaining_fund < 1000 ? 'text-remaining-low' : ''}">${formatCurrency(employee.remaining_fund)}</span></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass}">${statusText}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="editUser('${employee.id}', 'employee')" class="text-blue-600 hover:text-blue-900 mr-3">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="toggleUserStatus('${employee.id}', 'employee', ${employee.is_active})" class="${employee.is_active ? 'text-red-600 hover:text-red-900' : 'text-green-600 hover:text-green-900'}">
                                    <i class="fas ${employee.is_active ? 'fa-toggle-off' : 'fa-toggle-on'}"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                employeesTableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No employees found.</td></tr>`;
            }
        }

        function filterEmployees() {
            const searchValue = document.getElementById('searchEmployees').value.toLowerCase();
            const filteredEmployees = allEmployees.filter(employee =>
                employee.name.toLowerCase().includes(searchValue) ||
                employee.email.toLowerCase().includes(searchValue) ||
                (employee.admin_name && employee.admin_name.toLowerCase().includes(searchValue))
            );
            renderEmployeesTable(filteredEmployees);
        }

        function exportEmployees() {
            showToast('Exporting employees...', 'info');
             const headers = ["Name", "Email", "Assigned Admin", "Funds Allocated", "Funds Used", "Remaining", "Status"];
             const rows = allEmployees.map(employee => [
                 employee.name,
                 employee.email,
                 employee.admin_name || 'N/A',
                 formatCurrency(employee.allocated_fund).replace('₹', ''),
                 formatCurrency(employee.spent_fund).replace('₹', ''),
                 formatCurrency(employee.remaining_fund).replace('₹', ''),
                 employee.is_active ? 'Active' : 'Inactive'
             ]);

             let csvContent = "data:text/csv;charset=utf-8,"
                 + headers.join(",") + "\n"
                 + rows.map(e => e.join(",")).join("\n");

             const encodedUri = encodeURI(csvContent);
             const link = document.createElement("a");
             link.setAttribute("href", encodedUri);
             link.setAttribute("download", "employees_report.csv");
             document.body.appendChild(link);
             link.click();
             link.remove();
             showToast('Employees report exported successfully!', 'success');
        }

        async function toggleUserStatus(userId, role, currentStatus) {
            const newStatus = currentStatus ? 'inactive' : 'active';
            if (!confirm(`Are you sure you want to ${newStatus} this ${role}?`)) {
                return;
            }

            try {
                const endpoint = `/superadmin/employee/${userId}/toggle-status`; // Assuming this endpoint handles both admin and employee status toggle based on the 'employee' parameter
                // NOTE: Your backend superadmin.py currently only has '/employee/<int:employee_id>/toggle-status'.
                // If you need to toggle admin status, you'll need a similar endpoint for admins.
                // For now, I'm assuming this function will only be called for 'employee' role based on available backend.
                // If 'admin' role is passed, it will try to call the employee endpoint.

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                const result = await response.json();
                if (response.ok) {
                    showToast(result.message, 'success');
                    if (role === 'employee') {
                        loadEmployees();
                        loadDashboardData(); // Refresh overview for employee summary
                    } else if (role === 'admin') {
                        loadSupervisors();
                        loadDashboardData(); // Refresh overview for admin summary
                    }
                } else {
                    showToast(result.error || `Failed to ${newStatus} ${role}.`, 'error');
                }
            } catch (error) {
                console.error(`Error toggling ${role} status:`, error);
                showToast(`An error occurred while toggling ${role} status.`, 'error');
            }
        }


        let isEditMode = false;
        let currentEditingUserId = null;
        let currentEditingUserRole = null;

        function openAddUserModal(role = null) {
            isEditMode = false;
            currentEditingUserId = null;
            currentEditingUserRole = null;
            document.getElementById('addUserForm').reset();
            document.getElementById('addUserModalTitle').textContent = 'Add New User';
            document.getElementById('userPassword').setAttribute('required', 'true');
            document.getElementById('passwordHint').classList.add('hidden');
            document.getElementById('editUserId').value = '';
            document.getElementById('userStatusField').classList.add('hidden'); // Hide status for new user

            const userRoleSelect = document.getElementById('userRole');
            if (role) {
                userRoleSelect.value = role;
                userRoleSelect.setAttribute('disabled', 'true'); // Disable changing role if pre-selected
            } else {
                userRoleSelect.removeAttribute('disabled');
            }

            // Show/hide initial fund allocation based on role
            updateUserModalFields();
            userRoleSelect.addEventListener('change', updateUserModalFields);

            document.getElementById('addUserModal').classList.remove('hidden');
        }

        function updateUserModalFields() {
            const selectedRole = document.getElementById('userRole').value;
            const fundAllocationField = document.getElementById('fundAllocationField');
            const userFundAllocation = document.getElementById('userFundAllocation');
            userFundAllocation.removeAttribute('required'); // Always make it optional for add/edit

            if (selectedRole === 'admin') {
                fundAllocationField.classList.remove('hidden');
                userFundAllocation.setAttribute('placeholder', 'Initial budget for supervisor');
            } else if (selectedRole === 'employee') {
                fundAllocationField.classList.remove('hidden');
                userFundAllocation.setAttribute('placeholder', 'Initial fund for labour');
            } else {
                fundAllocationField.classList.add('hidden');
            }
        }

        async function editUser(userId, role) {
            isEditMode = true;
            currentEditingUserId = userId;
            currentEditingUserRole = role;
            document.getElementById('addUserForm').reset();
            document.getElementById('addUserModalTitle').textContent = `Edit ${role.charAt(0).toUpperCase() + role.slice(1)}`;
            document.getElementById('userPassword').removeAttribute('required');
            document.getElementById('passwordHint').classList.remove('hidden');
            document.getElementById('editUserId').value = userId;
            document.getElementById('userStatusField').classList.remove('hidden'); // Show status for editing

            const userRoleSelect = document.getElementById('userRole');
            userRoleSelect.value = role;
            userRoleSelect.setAttribute('disabled', 'true'); // Role cannot be changed on edit

            updateUserModalFields(); // Call to set fund allocation placeholder

            try {
                // Fetch user data based on role
                let userData = null;
                if (role === 'admin') {
                    const admin = allAdmins.find(a => a.id == userId);
                    if (admin) {
                        userData = { ...admin, initial_fund: admin.allocated }; // Map allocated to initial_fund for consistency
                    }
                } else if (role === 'employee') {
                    const employee = allEmployees.find(e => e.id == userId);
                    if (employee) {
                        userData = { ...employee, initial_fund: employee.allocated_fund }; // Map allocated_fund
                    }
                }

                if (userData) {
                    document.getElementById('addUserName').value = userData.name;
                    document.getElementById('userEmail').value = userData.email;
                    document.getElementById('userPhone').value = userData.phone || '';
                    document.getElementById('userFundAllocation').value = userData.initial_fund || '';
                    document.getElementById('userIsActive').checked = userData.is_active;
                } else {
                    showToast('User data not found for editing.', 'error');
                    closeAddUserModal();
                }

            } catch (error) {
                console.error('Error populating edit user modal:', error);
                showToast('Failed to load user data for editing.', 'error');
            }

            document.getElementById('addUserModal').classList.remove('hidden');
        }


        function closeAddUserModal() {
            document.getElementById('addUserModal').classList.add('hidden');
            document.getElementById('addUserForm').reset();
            document.getElementById('userRole').removeAttribute('disabled'); // Re-enable role selection
            document.getElementById('passwordHint').classList.add('hidden');
        }
// dashboard_superadmin.html

// ... (existing functions) ...

async function fetchDashboardStats() {
    try {
        const response = await fetch('/superadmin/dashboard-stats'); // Call the new endpoint
        const data = await response.json();

        if (response.ok) {
            document.getElementById('totalBudgetCard').textContent = `₹${data.total_budget_allocated.toLocaleString('en-IN')}`;
            document.getElementById('remainingBudgetCard').textContent = `₹${data.total_remaining_budget.toLocaleString('en-IN')}`;
            document.getElementById('totalSpentCard').textContent = `₹${data.total_approved_expenses.toLocaleString('en-IN')}`; // Or total_spent
            document.getElementById('totalAdminsCard').textContent = data.total_admins;
            document.getElementById('totalEmployeesCard').textContent = data.total_employees;
            document.getElementById('pendingRequestsCard').textContent = data.total_pending_expenses;
            // Add more elements as needed for total_employee_fund_allocated, total_employee_fund_spent
            // Example:
            // document.getElementById('employeeFundsAllocatedCard').textContent = `₹${data.total_employee_fund_allocated.toLocaleString('en-IN')}`;
            // document.getElementById('employeeFundsSpentCard').textContent = `₹${data.total_employee_fund_spent.toLocaleString('en-IN')}`;

        } else {
            console.error('Error fetching dashboard stats:', data.error);
            showToast(`Error: ${data.error}`, 'error');
        }
    } catch (error) {
        console.error('Network error fetching dashboard stats:', error);
        showToast('Failed to load dashboard statistics. Please try again.', 'error');
    }
}

// ... (rest of your existing functions) ...
        // Call this on page load
async function loadOverview() {
    try {
        const res = await fetch('/superadmin/overview', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to fetch overview');
        const data = await res.json();

        // Update cards
        document.getElementById('totalAllocated').textContent = `₹${data.stats.total_allocated.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
        document.getElementById('totalSpent').textContent = `₹${data.stats.total_spent.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
        document.getElementById('remainingFunds').textContent = `₹${(data.stats.total_allocated - data.stats.total_spent).toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
        document.getElementById('activeUsers').textContent = data.stats.active_admins;

        // You can also update supervisor/labour summaries here using data.budgets
        // Example: updateSupervisorSummary(data.budgets);
    } catch (err) {
        console.error('Overview load error:', err);
    }
}

// Call loadOverview() on DOMContentLoaded
document.addEventListener('DOMContentLoaded', loadOverview);
        document.getElementById('addUserForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const userId = document.getElementById('editUserId').value;
            const role = document.getElementById('userRole').value;
            const name = document.getElementById('addUserName').value;
            const email = document.getElementById('userEmail').value;
            const password = document.getElementById('userPassword').value;
            const phone = document.getElementById('userPhone').value;
            const initialFund = document.getElementById('userFundAllocation').value;
            const isActive = document.getElementById('userIsActive').checked;


            const data = { name, email, phone };
            if (password) { // Only send password if it's not empty (for updates)
                data.password = password;
            }
            if (!isEditMode) { // Initial fund and status only on add
                if (initialFund) data.initial_fund = parseFloat(initialFund);
            } else { // On edit, send is_active for employee toggle via 'edit-employee' or 'edit-admin'
                data.is_active = isActive;
            }


            let endpoint = '';
            let method = '';
            let successMessage = '';
            let errorMessage = '';

            if (isEditMode) {
                if (role === 'admin') {
                    endpoint = `/superadmin/edit-admin`; // Or a specific ID endpoint if your backend allows
                    method = 'PUT';
                    data.id = userId; // Add ID for update
                    successMessage = 'Supervisor updated successfully!';
                    errorMessage = 'Failed to update supervisor.';
                } else if (role === 'employee') {
                    endpoint = `/superadmin/edit-employee`; // Or a specific ID endpoint
                    method = 'PUT';
                    data.id = userId; // Add ID for update
                    successMessage = 'Labour updated successfully!';
                    errorMessage = 'Failed to update labour.';
                }
            } else { // Add new user
                if (role === 'admin') {
                    endpoint = '/superadmin/add-client'; // Add admin endpoint (current backend calls them client)
                    method = 'POST';
                    successMessage = 'New Supervisor added successfully!';
                    errorMessage = 'Failed to add supervisor.';
                } else if (role === 'employee') {
                    endpoint = '/superadmin/add-employee'; // Add employee endpoint
                    method = 'POST';
                    successMessage = 'New Labour added successfully!';
                    errorMessage = 'Failed to add labour.';
                }
            }

            if (!endpoint) {
                showToast('Invalid role or operation for user action.', 'error');
                return;
            }

            try {
                const response = await fetch(endpoint, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (response.ok) {
                    showToast(result.message || successMessage, 'success');
                    closeAddUserModal();
                    loadSupervisors(); // Refresh management tables
                    loadEmployees();
                    loadDashboardData(); // Refresh dashboard summary if user counts change
                } else {
                    showToast(result.error || errorMessage, 'error');
                }
            } catch (error) {
                console.error(`Error ${isEditMode ? 'updating' : 'adding'} user:`, error);
                showToast(`An error occurred while ${isEditMode ? 'updating' : 'adding'} user.`, 'error');
            }
        });


        // Reports Tab Functionality
        async function loadReportsData() {
            const reportsData = await fetch('/superadmin/reports'); // Assuming this endpoint provides data for charts
            const data = await reportsData.json();

            // Example: Monthly Expense Summary Chart
            const months = data.monthly_summary.map(item => item.month_name);
            const allocations = data.monthly_summary.map(item => item.total_allocated);
            const expenses = data.monthly_summary.map(item => item.total_spent);

            const expenseTrendsCtx = document.getElementById('expenseTrendsChart').getContext('2d');
            if (expenseTrendsChart) {
                expenseTrendsChart.destroy();
            }
            expenseTrendsChart = new Chart(expenseTrendsCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Total Allocations',
                            data: allocations,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'Total Expenses',
                            data: expenses,
                            borderColor: 'rgb(255, 99, 132)',
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (₹)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        },
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        async function downloadReport() {
            showToast('Generating and downloading full report...', 'info');
             try {
                const response = await fetch('/superadmin/reports-download'); // You need to implement this endpoint for full report
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'full_superadmin_report.pdf'; // Or .xlsx
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                showToast('Full report downloaded successfully!', 'success');
            } catch (error) {
                console.error('Error downloading full report:', error);
                showToast('Failed to download full report. Backend endpoint not implemented or failed.', 'error');
            }
        }


        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            fetchUserName(); // Fetch and display logged-in user's name
            switchTab('dashboard'); // Initialize with Dashboard tab active

            // Attach event listeners for desktop sidebar
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchTab(e.currentTarget.dataset.tab);
                });
            });

            document.getElementById('logoutBtnSidebar').addEventListener('click', logout);

            // Attach event listeners for mobile bottom nav
            document.querySelectorAll('.bottom-nav-item').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (e.currentTarget.dataset.tab) { // Check if it's a tab item
                        switchTab(e.currentTarget.dataset.tab);
                    } else if (e.currentTarget.id === 'mobileLogoutBtn') { // Handle logout button
                        logout();
                    }
                });
            });
             document.getElementById('mobileLogoutBtn').addEventListener('click', logout);


        });
    </script>
</body>
</html>